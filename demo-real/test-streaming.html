<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå¼åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .result-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            min-height: 200px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-area.streaming {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>ğŸŒŠ æµå¼åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
    
    <div class="status info">
        <strong>æµ‹è¯•è¯´æ˜ï¼š</strong>
        <ul>
            <li>æµ‹è¯•æµå¼å“åº”çš„å®æ—¶æ˜¾ç¤ºæ•ˆæœ</li>
            <li>éªŒè¯ä¿®å¤åçš„æµå¼ä½“éªŒä¼˜åŒ–</li>
            <li>æ£€æŸ¥æ‰“å­—æœºæ•ˆæœå’Œè§†è§‰åé¦ˆ</li>
        </ul>
    </div>
    
    <button class="test-button" onclick="testStreaming()">æµ‹è¯•æµå¼å“åº”</button>
    <button class="test-button" onclick="testMockStreaming()">æµ‹è¯•æ¨¡æ‹Ÿæµå¼</button>
    <button class="test-button" onclick="clearResult()">æ¸…ç©ºç»“æœ</button>
    
    <div class="result-area" id="test-result">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    
    <script>
        function clearResult() {
            document.getElementById('test-result').textContent = 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...';
        }
        
        function testStreaming() {
            const resultElement = document.getElementById('test-result');
            resultElement.textContent = 'æ­£åœ¨æµ‹è¯•çœŸå®æµå¼å“åº”...\n\n';
            resultElement.classList.add('streaming');
            
            const startTime = Date.now();
            
            fetch('/api/streaming-query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: 'è¯·ç®€è¦ä»‹ç»ä¸€ä¸‹äººå·¥æ™ºèƒ½çš„å‘å±•å†ç¨‹ï¼ŒåŒ…æ‹¬ä¸»è¦é‡Œç¨‹ç¢‘å’Œæœªæ¥è¶‹åŠ¿ã€‚',
                    allowedTools: ['Read'],
                    permissionMode: 'auto',
                    useFluent: true
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥: ' + response.status);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let content = '';
                
                function readStream() {
                    return reader.read().then(result => {
                        if (result.done) {
                            const endTime = Date.now();
                            const duration = endTime - startTime;
                            
                            resultElement.innerHTML = content.replace(/\n/g, '<br>') + `<br><br>âœ… æµå¼å“åº”å®Œæˆï¼<br>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:<br>â€¢ æ€»è€—æ—¶: ${duration}ms<br>â€¢ å­—ç¬¦æ•°: ${content.length}<br>â€¢ å¹³å‡é€Ÿåº¦: ${Math.round(content.length / (duration / 1000))} å­—ç¬¦/ç§’`;
                            resultElement.classList.remove('streaming');
                            return;
                        }
                        
                        const chunk = decoder.decode(result.value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const dataStr = line.substring(6);
                                    if (dataStr && dataStr.trim() !== '') {
                                        const parsed = JSON.parse(dataStr);
                                        
                                        if (parsed.type === 'content' && parsed.content) {
                                            content += parsed.content;
                                            resultElement.innerHTML = content.replace(/\n/g, '<br>') + '<span class="typing-cursor"></span>';
                                            resultElement.scrollTop = resultElement.scrollHeight;
                                        } else if (parsed.type === 'error') {
                                            throw new Error(parsed.error);
                                        }
                                    }
                                } catch (e) {
                                    console.warn('SSEè§£æé”™è¯¯:', e);
                                }
                            }
                        }
                        
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                console.error('æµå¼æµ‹è¯•é”™è¯¯:', error);
                resultElement.textContent = 'âŒ æµ‹è¯•å¤±è´¥: ' + error.message;
                resultElement.classList.remove('streaming');
            });
        }
        
        function testMockStreaming() {
            const resultElement = document.getElementById('test-result');
            resultElement.textContent = 'æ­£åœ¨æµ‹è¯•æ¨¡æ‹Ÿæµå¼å“åº”...\n\n';
            resultElement.classList.add('streaming');
            
            const mockContent = `è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„æµå¼å“åº”æµ‹è¯•ï¼Œç”¨äºéªŒè¯å‰ç«¯æ˜¾ç¤ºæ•ˆæœã€‚

ğŸŒŠ æµ‹è¯•å†…å®¹ï¼š
1. å®æ—¶æ˜¾ç¤ºæ•ˆæœ
2. æ‰“å­—æœºå…‰æ ‡åŠ¨ç”»
3. è‡ªåŠ¨æ»šåŠ¨åŠŸèƒ½
4. è§†è§‰åé¦ˆä¼˜åŒ–

ğŸ“ æŠ€æœ¯ç‰¹ç‚¹ï¼š
â€¢ ä½¿ç”¨textContentè€Œä¸æ˜¯innerHTML
â€¢ white-space: pre-wrap ä¿æŒæ ¼å¼
â€¢ CSSåŠ¨ç”»æ•ˆæœ
â€¢ æµç•…çš„æ»šåŠ¨ä½“éªŒ

ğŸš€ ä¼˜åŒ–æ”¹è¿›ï¼š
â€¢ å‡å°‘DOMæ“ä½œé¢‘ç‡
â€¢ æ”¹è¿›æ¢è¡Œç¬¦å¤„ç†
â€¢ æ·»åŠ è§†è§‰çŠ¶æ€åé¦ˆ
â€¢ ä¼˜åŒ–æ€§èƒ½è¡¨ç°

âœ… æ¨¡æ‹Ÿæµ‹è¯•å®Œæˆï¼`;

            let index = 0;
            const speed = 30; // å­—ç¬¦/ç§’
            
            function typeCharacter() {
                if (index < mockContent.length) {
                    resultElement.innerHTML = mockContent.substring(0, index + 1).replace(/\n/g, '<br>') + '<span class="typing-cursor"></span>';
                    resultElement.scrollTop = resultElement.scrollHeight;
                    index++;
                    setTimeout(typeCharacter, 1000 / speed);
                } else {
                    resultElement.innerHTML = mockContent.replace(/\n/g, '<br>');
                    resultElement.classList.remove('streaming');
                }
            }
            
            typeCharacter();
        }
    </script>
</body>
</html>