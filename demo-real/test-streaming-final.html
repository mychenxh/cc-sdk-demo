<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå¼å“åº”æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .result-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            min-height: 200px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-area.streaming {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        /* æ‰“å­—æœºå…‰æ ‡æ•ˆæœ */
        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background-color: #0ea5e9;
            animation: blink 1s infinite;
            margin-left: 2px;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .stats {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸŒŠ æµå¼å“åº”æµ‹è¯•é¡µé¢</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„æµå¼å“åº”æ•ˆæœã€‚</p>
        
        <button class="test-button" onclick="testStreaming()" id="testBtn">å¼€å§‹æµå¼æµ‹è¯•</button>
        <button class="test-button" onclick="clearResult()" style="background: #6c757d;">æ¸…ç©ºç»“æœ</button>
        
        <div class="result-area" id="result">ç‚¹å‡»"å¼€å§‹æµå¼æµ‹è¯•"æŒ‰é’®æ¥æµ‹è¯•æµå¼å“åº”æ•ˆæœ...</div>
        
        <div class="stats" id="stats" style="display: none;">
            <strong>ğŸ“Š æµå¼ç»Ÿè®¡ä¿¡æ¯ï¼š</strong>
            <div id="statsContent"></div>
        </div>
    </div>

    <script>
        function clearResult() {
            document.getElementById('result').innerHTML = 'ç‚¹å‡»"å¼€å§‹æµå¼æµ‹è¯•"æŒ‰é’®æ¥æµ‹è¯•æµå¼å“åº”æ•ˆæœ...';
            document.getElementById('result').classList.remove('streaming');
            document.getElementById('stats').style.display = 'none';
        }
        
        async function testStreaming() {
            const btn = document.getElementById('testBtn');
            const result = document.getElementById('result');
            const stats = document.getElementById('stats');
            const statsContent = document.getElementById('statsContent');
            
            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';
            
            result.innerHTML = 'ğŸŒŠ æ­£åœ¨è¿æ¥æœåŠ¡å™¨...\n\n';
            result.classList.add('streaming');
            stats.style.display = 'none';
            
            const startTime = Date.now();
            let chunkCount = 0;
            let totalContent = '';
            let estimatedTotal = 800; // åŸºäºå†å²æ•°æ®çš„ä¼°ç®—
            
            // åœ¨æ–‡æœ¬æ¡†å†…æ˜¾ç¤ºç´¯è®¡å­—æ•°/æ€»å­—æ•°çš„å‡½æ•°
            function updateTextWithProgress() {
                const progressText = `ğŸ“Š ${totalContent.length}/${estimatedTotal} å­—ç¬¦ (${Math.round((totalContent.length / estimatedTotal) * 100)}%)`;
                const displayContent = 'ğŸŒŠ æ­£åœ¨è¿æ¥æœåŠ¡å™¨... | ' + progressText + '\n\n' + totalContent;
                result.innerHTML = displayContent.replace(/\n/g, '<br>');
                result.scrollTop = result.scrollHeight;
            }
            
            try {
                const response = await fetch('/api/streaming-query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: 'è¯·ç®€å•ä»‹ç»ä¸€ä¸‹äººå·¥æ™ºèƒ½åœ¨ç°ä»£ç¤¾ä¼šä¸­çš„åº”ç”¨é¢†åŸŸï¼ŒåŒ…æ‹¬æ•™è‚²ã€åŒ»ç–—ã€é‡‘èç­‰æ–¹é¢çš„å…·ä½“æ¡ˆä¾‹ã€‚',
                        allowedTools: ['Read'],
                        permissionMode: 'auto',
                        useFluent: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        const endTime = Date.now();
                        const duration = endTime - startTime;
                        const avgSpeed = Math.round(totalContent.length / (duration / 1000));
                        
                        // æ›´æ–°ä¼°ç®—çš„æ€»å­—æ•°
                        estimatedTotal = totalContent.length;
                        
                        // æ˜¾ç¤ºæœ€ç»ˆç»“æœï¼ˆç§»é™¤å…‰æ ‡ï¼‰
                        const finalProgressText = `ğŸ“Š ${totalContent.length}/${totalContent.length} å­—ç¬¦ (100%)`;
                        const finalContent = 'ğŸŒŠ æ­£åœ¨è¿æ¥æœåŠ¡å™¨... | ' + finalProgressText + '\n\n' + totalContent + '\n\nâœ… æµå¼å“åº”å®Œæˆï¼';
                        result.innerHTML = finalContent.replace(/\n/g, '<br>');
                        result.classList.remove('streaming');
                        
                        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                        statsContent.innerHTML = `
                            â€¢ æ€»è€—æ—¶: ${duration}ms<br>
                            â€¢ æ€»å­—ç¬¦æ•°: ${totalContent.length}<br>
                            â€¢ æ•°æ®å—æ•°: ${chunkCount}<br>
                            â€¢ å¹³å‡é€Ÿåº¦: ${avgSpeed} å­—ç¬¦/ç§’
                        `;
                        stats.style.display = 'block';
                        
                        break;
                    }
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const dataStr = line.substring(6);
                                if (dataStr && dataStr.trim() !== '') {
                                    const parsed = JSON.parse(dataStr);
                                    
                                    if (parsed.type === 'content' && parsed.content) {
                                        totalContent += parsed.content;
                                        chunkCount++;
                                        
                                        // å®æ—¶æ˜¾ç¤ºï¼ˆå¸¦å…‰æ ‡å’Œè¿›åº¦ï¼‰
                                        updateTextWithProgress();
                                    }
                                }
                            } catch (e) {
                                // å¿½ç•¥è§£æé”™è¯¯
                            }
                        }
                    }
                }
                
            } catch (error) {
                result.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                result.classList.remove('streaming');
            } finally {
                btn.disabled = false;
                btn.textContent = 'å¼€å§‹æµå¼æµ‹è¯•';
            }
        }
    </script>
</body>
</html>